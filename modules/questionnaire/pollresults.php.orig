<?php

/* ========================================================================
 * Open eClass 3.0
 * E-learning and Course Management System
 * ========================================================================
 * Copyright 2003-2014  Greek Universities Network - GUnet
 * A full copyright notice can be read in "/info/copyright.txt".
 * For a full list of contributors, see "credits.txt".
 *
 * Open eClass is an open platform distributed in the hope that it will
 * be useful (without any warranty), under the terms of the GNU (General
 * Public License) as published by the Free Software Foundation.
 * The full license can be read in "/info/license/license_gpl.txt".
 *
 * Contact address: GUnet Asynchronous eLearning Group,
 *                  Network Operations Center, University of Athens,
 *                  Panepistimiopolis Ilissia, 15784, Athens, Greece
 *                  e-mail: info@openeclass.org
 * ======================================================================== */

<<<<<<< local

=======
$require_editor = TRUE;
>>>>>>> other
$require_current_course = TRUE;
$require_help = TRUE;
$helpTopic = 'Questionnaire';

require_once '../../include/baseTheme.php';
require_once 'modules/graphics/plotter.php';
load_js('jquery');

$nameTools = $langPollCharts;
$navigation[] = array('url' => "index.php?course=$course_code", 'name' => $langQuestionnaire);

$questions = array();
$answer_total = 0;

if (!$is_editor) {
    Session::set_flashdata($langPollResultsAccess, 'alert1');
    redirect_to_home_page('modules/questionnaire/index.php?course='.$course_code);    
}
load_js('jquery');

if (!isset($_GET['pid']) || !is_numeric($_GET['pid'])) {
    header("Location: $urlServer");
} else {
    $pid = $_GET['pid'];
}

$thePoll = Database::get()->querySingle("SELECT * FROM poll WHERE course_id = ?d AND pid = ?d ORDER BY pid", $course_id, $pid);

$tool_content .= "
<div class='info'>
<b>$langDumpUserDurationToFile: </b>1. <a href='dumppollresults.php?course=$course_code&amp;pid=$pid'>$langcsvenc2</a>
2. <a href='dumppollresults.php?course=$course_code&amp;enc=1253&amp;pid=$pid'>$langcsvenc1</a>          
</div>";

$tool_content .= "
<p class='sub_title1'>$langSurvey</p>
<table class='tbl_border'>
<tr>
        <th width='150'>$langTitle:</th>
        <td>" . $thePoll->name . "</td>
</tr>
<tr>
        <th>$langPollCreation:</th>
        <td>" . nice_format(date("Y-m-d H:i", strtotime($thePoll->creation_date)), true) . "</td>
</tr>
<tr>
        <th>$langPollStart:</th>
        <td>" . nice_format(date("Y-m-d H:i", strtotime($thePoll->start_date)), true) . "</td>
</tr>
<tr>
        <th>$langPollEnd:</th>
        <td>" . nice_format(date("Y-m-d H:i", strtotime($thePoll->end_date)), true) . "</td>
</tr>
</table>
<p class='sub_title1'>$langAnswers</p>";
$tool_content .= "<table class='tbl' width='100%'>";

$q = Database::get()->queryArray("SELECT * FROM poll_question WHERE pid = ?d ORDER BY qtype", $pid);
foreach ($q as $questions) {
    if ($questions->qtype == 'multiple') {
        $tool_content .= "
        <tr>
<<<<<<< local
                <td width='50'><b>$langQuestion:</b></td>
                <td>$theQuestion[question_text]</td>
        </tr>
        <tr>
            <td colspan='2'>";
    if ($theQuestion['qtype'] == 'multiple') {
        $answers = db_query("SELECT COUNT(aid) AS count, aid, poll_question_answer.answer_text AS answer
=======
        <th>$questions->question_text</th>
        <td>";        
        $a = Database::get()->queryArray("SELECT COUNT(aid) AS count, aid, poll_question_answer.answer_text AS answer
>>>>>>> other
                        FROM poll_answer_record LEFT JOIN poll_question_answer
                        ON poll_answer_record.aid = poll_question_answer.pqaid
                        WHERE qid = ?d GROUP BY aid", $questions->pqid);        
        $answer_counts = array();
<<<<<<< local
        $answer_text = array();
        while ($theAnswer = mysql_fetch_array($answers)) {
            $answer_counts[$theAnswer['aid']] = $theAnswer['count'];
            $answer_total += $theAnswer['count'];
            if ($theAnswer['aid'] < 0) {
                $answer_text[$theAnswer['aid']] = $langPollUnknown;
=======
        $answer_text = array();        
        foreach ($a as $answer) {
            $answer_counts[] = $answer->count;
            $answer_total += $answer->count;
            if ($answer->aid < 0) {
                $answer_text[] = $langPollUnknown;
>>>>>>> other
            } else {
<<<<<<< local
                $answer_text[$theAnswer['aid']] = $theAnswer['answer'];
=======
                $answer_text[] = $answer->answer;
>>>>>>> other
            }
        }
        $chart = new Plotter(500, 300);
        $answers_table = "
            <table class='tbl_border' width='100%'>
                <tr>
                    <th width='30%'>$langAnswer</th>
                    <th width='30%'>$langSurveyTotalAnswers</th>".(($thePoll["anonymized"]==1)?'':'<th>'.$langStudents.'</th>')."</tr>";
        foreach ($answer_counts as $i => $count) {
            $percentage = round(100 * ($count / $answer_total),2);
            $chart->addPoint($answer_text[$i], $percentage);
            
            if ($thePoll["anonymized"]!=1) {
            $names = Database::get()->queryArray("SELECT CONCAT(b.givenname, ' ', b.surname) AS fullname FROM poll_answer_record AS a, user AS b WHERE a.aid = ?d AND a.user_id = b.id", $i);
            $names_str = implode(', ', array_map(function($n) {
                return $n->fullname;
            }, $names));            

            }
            $answers_table .= "
                <tr>
                        <td>$answer_text[$i]</th>
                        <td>$count</td>".(($thePoll["anonymized"]==1)?'':'<td>'.$names_str.'</td>')."</tr>";  
        }
        $answers_table .= "</table><br>";
        $chart->normalize();
        $tool_content .= $chart->plot();
<<<<<<< local
        $tool_content .= $answers_table;
    } else {
        $answers = db_query("SELECT answer_text, user_id FROM poll_answer_record
                                WHERE qid = $theQuestion[pqid]", $mysqlMainDb);
        $answer_total = mysql_num_rows($answers);
        $tool_content .= "<table class='tbl_border' width='100%'>
                <tbody>
                <tr>
                        <th width='20%'>$langUser</th>
                        <th width='80%'>$langAnswer</th>
                </tr>";       
        if ($thePoll["anonymized"]==1) {
            $i=1;
             while ($theAnswer = mysql_fetch_array($answers)) {     
                $tool_content .= "
                <tr>
                        <td>$langMetaLearner $i</th>
                        <td>$theAnswer[answer_text]</td>
                </tr>";                
                $i++;    
            }           
        } else {
            while ($theAnswer = mysql_fetch_array($answers)) {
                $tool_content .= "
                <tr>
                        <td>" . q(uid_to_name($theAnswer['user_id'])) ."</th>
                        <td>$theAnswer[answer_text]</td>
                </tr>";                     
            }
=======
        $tool_content .= "</td></tr>";
    } else {        
        $tool_content .= "<tr><th colspan='2'>$questions->question_text</th></tr>";        
        $a = Database::get()->queryArray("SELECT answer_text, user_id FROM poll_answer_record
                                WHERE qid = ?d", $questions->pqid);        
        foreach ($a as $answer) {
            $tool_content .= "<tr><td>" . display_user($answer->user_id) . "</td>"
                                        . "<td>$answer->answer_text</td></tr>";
>>>>>>> other
        }
<<<<<<< local
        $tool_content .= '</tbody></table><br>';
=======
        $tool_content .= "<tr><td colspan='2'>&nbsp;</td></tr>";
>>>>>>> other
    }
}

$t = Database::get()->querySingle("SELECT COUNT(DISTINCT user_id) AS total FROM poll_answer_record WHERE pid = ?d", $pid);
$tool_content .= "
<tr>
        <th colspan='2'>$langPollTotalAnswers: $t->total</th>
</tr>
</table>";
<<<<<<< local
// display page
draw($tool_content, 2, null, $head_content);=======
draw($tool_content, 2, null, $head_content);
>>>>>>> other
